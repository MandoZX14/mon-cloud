<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4_4agQc-TefAeZNgTZvQMkCg7VUzq4ko",
            authDomain: "door-52b7f.firebaseapp.com",
            projectId: "door-52b7f",
            storageBucket: "door-52b7f.firebasestorage.app",
            messagingSenderId: "225584391077",
            appId: "1:225584391077:web:8bf224eedc0b42a5e13e4c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- SYST√àME DE VERROUILLAGE AVEC EFFETS ---
        const SECRET_CODE = "1234"; 
        const passInput = document.getElementById('passInput');
        const lockBox = document.querySelector('.lock-box');
        const lockError = document.getElementById('lock-error');

        const checkAuth = () => {
            if(localStorage.getItem('mando_auth') === 'true') {
                document.getElementById('lock-screen').style.display = 'none';
                loadMessages();
            }
        };

        passInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                if(passInput.value === SECRET_CODE) {
                    // EFFET CODE BON ‚úÖ
                    lockBox.style.borderColor = "#00ff88";
                    lockError.style.color = "#00ff88";
                    lockError.innerHTML = "ACC√àS AUTORIS√â ‚úÖ <br> Connexion...";
                    lockError.style.display = "block";
                    
                    setTimeout(() => {
                        localStorage.setItem('mando_auth', 'true');
                        location.reload();
                    }, 800);

                } else {
                    // EFFET CODE FAUX ‚ùå
                    lockBox.style.animation = "shake 0.4s darkred";
                    lockBox.style.borderColor = "red";
                    lockError.innerHTML = "CODE INCORRECT ‚ùå <br> R√©essaye...";
                    lockError.style.color = "red";
                    lockError.style.display = "block";
                    passInput.value = "";
                    
                    // On remet la couleur normale apr√®s 1 seconde
                    setTimeout(() => { lockBox.style.borderColor = "rgba(255,255,255,0.1)"; }, 1000);
                }
            }
        });

        // AJOUT DE L'ANIMATION DE TREMBLEMENT DANS LE HEAD (via JS)
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes shake {
                0% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                50% { transform: translateX(10px); }
                75% { transform: translateX(-10px); }
                100% { transform: translateX(0); }
            }
        `;
        document.head.appendChild(style);

        // --- RESTE DU CODE (FONCTIONNEMENT CLOUD) ---
        const loadMessages = () => {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const msgs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render(msgs);
            });
        };

        const render = (msgs) => {
            const cont = document.getElementById('chat-container');
            cont.innerHTML = "";
            let stats = { img: 0, doc: 0, size: 0 };

            msgs.forEach(m => {
                if(m.type === 'image') stats.img++; else if(m.type === 'file') stats.doc++;
                stats.size += (m.fileSize || 0);

                const wrap = document.createElement('div');
                wrap.className = 'bubble';
                wrap.style.marginBottom = "10px";
                wrap.innerHTML = `
                    <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>${m.createdAt?.toDate().toLocaleTimeString() || '--:--'}</span>
                        <span onclick="window.deleteMsg('${m.id}')" style="cursor:pointer; color:var(--danger)">Supprimer</span>
                    </div>
                    ${m.text ? `<p style="margin:0">${m.text}</p>` : ''}
                    ${m.type === 'image' ? `<img src="${m.url}" class="img-preview" onclick="window.open('${m.url}')">` : ''}
                    ${m.type === 'file' ? `<div class="file-box" onclick="window.open('${m.url}')">üìÅ ${m.fileName}</div>` : ''}
                `;
                cont.appendChild(wrap);
            });

            const percent = ((stats.size / (5*1024*1024*1024)) * 100).toFixed(2);
            document.getElementById('storage-fill').style.width = percent + '%';
            document.getElementById('storage-text').textContent = percent + '%';
            document.getElementById('count-img').textContent = stats.img;
            document.getElementById('count-docs').textContent = stats.doc;
            cont.scrollTop = cont.scrollHeight;
        };

        const upload = (file) => {
            const path = `genesis/${Date.now()}_${file.name}`;
            const task = uploadBytesResumable(ref(storage, path), file);
            const bar = document.getElementById('upload-progress');

            task.on('state_changed', 
                (s) => bar.style.width = (s.bytesTransferred/s.totalBytes)*100 + '%',
                null, 
                async () => {
                    const url = await getDownloadURL(task.snapshot.ref);
                    await addDoc(collection(db, "messages"), {
                        url, type: file.type.startsWith('image/') ? 'image' : 'file',
                        fileName: file.name, fileSize: file.size, storagePath: path, createdAt: serverTimestamp()
                    });
                    bar.style.width = '0%';
                }
            );
        };

        window.deleteMsg = async (id) => {
            if(!confirm("Supprimer d√©finitivement de Google Cloud ?")) return;
            const s = await getDoc(doc(db, "messages", id));
            if(s.exists() && s.data().storagePath) await deleteObject(ref(storage, s.data().storagePath));
            await deleteDoc(doc(db, "messages", id));
        };

        document.getElementById('sendBtn').onclick = async () => {
            const i = document.getElementById('msgInput');
            if(!i.value.trim()) return;
            await addDoc(collection(db, "messages"), { text: i.value, type: 'text', createdAt: serverTimestamp() });
            i.value = "";
        };

        document.getElementById('fileInput').onchange = (e) => upload(e.target.files[0]);

        // DRAG & DROP
        const ov = document.getElementById('dragOverlay');
        window.ondragover = (e) => { e.preventDefault(); ov.style.display = 'flex'; };
        window.ondragleave = () => { ov.style.display = 'none'; };
        window.ondrop = (e) => { e.preventDefault(); ov.style.display = 'none'; upload(e.dataTransfer.files[0]); };

        checkAuth();
    </script>
