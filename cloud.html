<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mando Cloud - Priv√©</title>
    <style>
        :root { --bg: #36393f; --panel: #2f3136; --msg-bg: #40444b; --accent: #5865f2; --text: #dcddde; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Liste des messages */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
        .message-card { background: var(--msg-bg); padding: 12px; border-radius: 8px; max-width: 85%; align-self: flex-start; position: relative; }
        .timestamp { font-size: 0.7rem; color: #72767d; margin-bottom: 4px; display: block; }
        .message-img { max-width: 100%; border-radius: 5px; margin-top: 8px; display: block; }

        /* Barre d'envoi en bas */
        .input-area { background: var(--panel); padding: 15px; display: flex; gap: 10px; align-items: center; position: fixed; bottom: 60px; left: 0; right: 0; }
        input[type="text"] { flex: 1; background: #40444b; border: none; padding: 10px; border-radius: 5px; color: white; outline: none; }
        
        /* Barre d'onglets (Navigation) */
        .nav-bar { height: 60px; background: #202225; display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; }
        .nav-item { cursor: pointer; color: #b9bbbe; font-size: 0.8rem; text-decoration: none; text-align: center; }
        .nav-item:hover { color: white; }
        .nav-item.active { color: var(--accent); font-weight: bold; }

        /* Boutons */
        .btn { background: var(--accent); border: none; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .file-label { background: #4f545c; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

    <div id="chat-container"></div>

    <div class="input-area">
        <label class="file-label" title="Envoyer une image">
            üñºÔ∏è <input type="file" id="imageInput" hidden accept="image/*">
        </label>
        <input type="text" id="msgInput" placeholder="√âcris un message ou colle un lien...">
        <button id="sendBtn" class="btn">Envoyer</button>
    </div>

    <nav class="nav-bar">
        <a href="#" class="nav-item active">üí¨ G√©n√©ral</a>
        <a href="#" class="nav-item">üë• Groupes</a>
        <a href="#" class="nav-item">üìÅ Fichiers</a>
        <a href="#" class="nav-item">‚öôÔ∏è Param√®tres</a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            projectId: "sation-44d19",
            storageBucket: "sation-44d19.appspot.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const msgCol = collection(db, "messages");

        const chatContainer = document.getElementById('chat-container');
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const imageInput = document.getElementById('imageInput');

        // FONCTION : Envoyer
        const sendMessage = async (imageUrl = null) => {
            const text = msgInput.value.trim();
            if (text === "" && !imageUrl) return;

            await addDoc(msgCol, {
                text: text,
                image: imageUrl,
                createdAt: serverTimestamp()
            });
            msgInput.value = "";
        };

        sendBtn.onclick = () => sendMessage();

        // G√©rer l'upload d'image
        imageInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const storageRef = ref(storage, 'chat_images/' + Date.now() + "_" + file.name);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            sendMessage(url);
        };

        // Affichage en temps r√©el (Anti-Injection & Date)
        const q = query(msgCol, orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
            chatContainer.innerHTML = "";
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = "message-card";

                // Formatage de la date
                const date = data.createdAt ? data.createdAt.toDate().toLocaleString('fr-FR', {hour: '2-digit', minute:'2-digit'}) : "...";
                
                // On utilise textContent pour la s√©curit√© (Anti-XSS)
                const timeSpan = document.createElement('span');
                timeSpan.className = "timestamp";
                timeSpan.textContent = date;
                div.appendChild(timeSpan);

                if (data.text) {
                    const textP = document.createElement('p');
                    textP.style.margin = "0";
                    textP.textContent = data.text; // S√âCURIT√â ICI
                    div.appendChild(textP);
                }

                if (data.image) {
                    const img = document.createElement('img');
                    img.src = data.image;
                    img.className = "message-img";
                    div.appendChild(img);
                }

                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    </script>
</body>
</html>
