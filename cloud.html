<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mando Cloud | Genesis Edition</title>
    <style>
        :root {
            --accent: #0088cc; --accent-glow: rgba(0, 136, 204, 0.4);
            --bg: #0a0b10; --glass: rgba(23, 28, 41, 0.8);
            --text: #ffffff; --text-dim: #8e9297;
            --danger: #ff4444;
        }
        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg); color: var(--text); margin: 0;
            height: 100vh; display: flex; overflow: hidden;
            background-image: radial-gradient(circle at top right, #1a1c2c, transparent), radial-gradient(circle at bottom left, #0d1117, transparent);
        }

        /* UI ELEMENTS */
        #upload-progress { position: fixed; top: 0; left: 0; height: 4px; background: var(--accent); width: 0%; z-index: 2000; box-shadow: 0 0 10px var(--accent); }
        
        .sidebar { width: 300px; background: var(--glass); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; padding: 25px; z-index: 10; }
        
        .storage-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 10px; overflow: hidden; }
        #storage-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }

        .search-box { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 8px 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .search-box input { background: transparent; border: none; color: white; outline: none; width: 100%; font-size: 0.85rem; }

        .stat-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }

        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        #chat-container { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .msg-container { max-width: 75%; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .bubble { background: var(--glass); padding: 14px; border-radius: 18px 18px 18px 4px; border: 1px solid rgba(255,255,255,0.1); }
        .img-preview { max-width: 100%; border-radius: 10px; margin-top: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .file-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px; margin-top: 5px; cursor: pointer; border: 1px dashed rgba(255,255,255,0.2); }
        
        .input-bar { padding: 20px 40px; }
        .input-wrapper { background: var(--glass); border-radius: 20px; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .input-wrapper input { flex: 1; background: transparent; border: none; color: white; outline: none; }
        
        .drag-overlay { position: fixed; inset: 0; background: var(--accent-glow); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; border: 4px dashed var(--accent); pointer-events: none; }
    </style>
</head>
<body>

    <div id="upload-progress"></div>
    <div class="drag-overlay" id="dragOverlay"><h1>L√ÇCHEZ POUR ENVOYER üöÄ</h1></div>

    <aside class="sidebar">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="width: 60px; height: 60px; background: linear-gradient(45deg, var(--accent), #00d4ff); border-radius: 15px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.4rem;">M</div>
            <h2 style="margin:0; font-size: 1.2rem;">Mando Cloud</h2>
            <p style="color:var(--text-dim); font-size: 0.7rem;">v2.2 Genesis REAL-SYNC</p>
        </div>

        <div class="search-box">
            <span>üîç</span>
            <input type="text" id="searchInput" placeholder="Rechercher...">
        </div>

        <div class="stat-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>‚òÅÔ∏è Cloud (5Go)</span>
                <b id="storage-text">0%</b>
            </div>
            <div class="storage-bar"><div id="storage-fill"></div></div>
        </div>

        <div class="stat-card">üñºÔ∏è <b id="count-img">0</b> Images</div>
        <div class="stat-card">üìÑ <b id="count-docs">0</b> Fichiers</div>

        <div style="margin-top: auto;">
            <button onclick="location.reload()" style="width:100%; padding:12px; border-radius:10px; background:rgba(255,255,255,0.05); color:white; border:none; cursor:pointer; font-weight: 600;">üîÑ Sync Cloud</button>
        </div>
    </aside>

    <main class="main-content">
        <div id="chat-container"></div>
        <div class="input-bar">
            <div class="input-wrapper">
                <label style="cursor:pointer; font-size: 1.2rem;">üìé <input type="file" id="fileInput" hidden></label>
                <input type="text" id="msgInput" placeholder="Message ou glisse un fichier...">
                <div id="sendBtn" style="color:var(--accent); cursor:pointer; font-size: 1.2rem;">üöÄ</div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4_4agQc-TefAeZNgTZvQMkCg7VUzq4ko",
            authDomain: "door-52b7f.firebaseapp.com",
            databaseURL: "https://door-52b7f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "door-52b7f",
            storageBucket: "door-52b7f.firebasestorage.app",
            messagingSenderId: "225584391077",
            appId: "1:225584391077:web:8bf224eedc0b42a5e13e4c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let allMessages = [];

        // --- CHARGEMENT DES DONN√âES ---
        const loadMessages = () => {
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                allMessages = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMessages(allMessages);
            });
        };

        const renderMessages = (msgs) => {
            const cont = document.getElementById('chat-container');
            cont.innerHTML = "";
            let stats = { img: 0, doc: 0, size: 0 };

            msgs.forEach(m => {
                if(m.type === 'image') stats.img++; else if(m.type === 'file') stats.doc++;
                if(m.fileSize) stats.size += m.fileSize;

                const time = m.createdAt ? m.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
                const wrap = document.createElement('div');
                wrap.className = 'msg-container';
                
                let contentHTML = m.text ? `<p style="margin:0">${m.text}</p>` : '';
                if(m.type === 'image') contentHTML += `<img src="${m.url}" class="img-preview" onclick="window.open('${m.url}')">`;
                if(m.type === 'file') contentHTML += `<div class="file-box" onclick="window.open('${m.url}')">üìÅ <div>${m.fileName}</div></div>`;

                wrap.innerHTML = `<div class="bubble">
                    <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>${time}</span>
                        <span onclick="deleteMsg('${m.id}')" style="cursor:pointer; color:var(--danger)">Supprimer</span>
                    </div>
                    ${contentHTML}
                </div>`;
                cont.appendChild(wrap);
            });

            const limit = 5 * 1024 * 1024 * 1024; // 5GB
            const percent = ((stats.size / limit) * 100).toFixed(2);
            document.getElementById('storage-fill').style.width = percent + '%';
            document.getElementById('storage-text').textContent = percent + '%';
            document.getElementById('count-img').textContent = stats.img;
            document.getElementById('count-docs').textContent = stats.doc;
            cont.scrollTop = cont.scrollHeight;
        };

        // --- UPLOAD ---
        const uploadAndSend = (file) => {
            if(!file) return;
            const isImg = file.type.startsWith('image/');
            const path = `genesis/${Date.now()}_${file.name}`;
            const sRef = ref(storage, path);
            const uploadTask = uploadBytesResumable(sRef, file);
            const progressBar = document.getElementById('upload-progress');

            uploadTask.on('state_changed', 
                (snap) => progressBar.style.width = (snap.bytesTransferred / snap.totalBytes) * 100 + '%',
                () => alert("Erreur upload"),
                async () => {
                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                    await addDoc(collection(db, "messages"), {
                        url, type: isImg ? 'image' : 'file', fileName: file.name, fileSize: file.size, storagePath: path, createdAt: serverTimestamp()
                    });
                    progressBar.style.width = '0%';
                }
            );
        };

        // --- SUPPRESSION TOTALE ---
        window.deleteMsg = async (id) => {
            if(!confirm("Supprimer d√©finitivement de Google Cloud ?")) return;
            const docRef = doc(db, "messages", id);
            const snap = await getDoc(docRef);
            
            if(snap.exists() && snap.data().storagePath) {
                try { await deleteObject(ref(storage, snap.data().storagePath)); } catch(e) { console.log("Fichier d√©j√† absent du storage"); }
            }
            await deleteDoc(docRef);
        };

        // --- ACTIONS ---
        const sendMsg = async () => {
            const inp = document.getElementById('msgInput');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "messages"), { text: inp.value, type: 'text', createdAt: serverTimestamp(), fileSize: 0
